name: Lint

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y curl docker-compose python3-pip
        pip3 install --upgrade pip
        pip3 install yamllint ansible-lint
        # install hadolint
        curl -sL https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 -o /usr/local/bin/hadolint
        sudo chmod +x /usr/local/bin/hadolint

    - name: Lint Dockerfiles (hadolint)
      run: |
        echo "Running hadolint on Dockerfiles..."
        if [ -f backend/Dockerfile ]; then hadolint backend/Dockerfile || true; fi
        if [ -f backend/Dockerfile.prod ]; then hadolint backend/Dockerfile.prod || true; fi

    - name: Validate docker-compose files
      run: |
        echo "Validating docker-compose.yml"
        docker-compose -f docker-compose.yml config
        echo "Validating docker-compose.prod.yml"
        docker-compose -f docker-compose.prod.yml config || true

    - name: YAML lint
      run: |
        yamllint -c > /dev/null 2>&1 || true
        echo "Running yamllint on repo YAML files"
        yamllint . || true

    - name: Ansible lint (if playbooks exist)
      run: |
        set -e
        playbooks=$(find . -type f -name "*.yml" -o -name "*.yaml" | xargs grep -l "hosts:\|tasks:\|roles:" || true)
        if [ -n "$playbooks" ]; then
          echo "Found possible Ansible playbooks; running ansible-lint"
          ansible-lint $playbooks || true
        else
          echo "No Ansible playbooks detected; skipping ansible-lint"
        fi

    - name: Summary
      run: echo "Lint job finished (tools provide more detailed output above)."